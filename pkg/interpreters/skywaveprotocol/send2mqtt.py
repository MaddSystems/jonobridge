#!/usr/bin/env python3
"""
MQTT Test Sender for SkyWave XML Data

This program sends hex-encoded SkyWave XML data to MQTT for testing purposes.
It publishes to the same topic that the Go service uses: 'skywave/xml'
# Make sure paho-mqtt is installed
pip3 install paho-mqtt

# Set the MQTT broker host (if not localhost)
export MQTT_BROKER_HOST="localhost"  # Change as needed

# Run the script
python3 mqtt_test_sender.py

"""

import paho.mqtt.client as mqtt
import sys
import os

# MQTT Configuration
MQTT_BROKER_HOST = os.getenv('MQTT_BROKER_HOST', 'localhost')
MQTT_PORT = 1883
MQTT_TOPIC = 'skywave/xml'
MQTT_CLIENT_ID = 'test-sender-python'

# Hex-encoded XML data (from your Go main.go output)
HEX_DATA = "3c3f786d6c2076657273696f6e3d22312e302220656e636f64696e673d227574662d38223f3e3c47657452657475726e4d65737361676573526573756c7420786d6c6e733a7873643d22687474703a2f2f7777772e77332e6f72672f323030312f584d4c536368656d612220786d6c6e733a7873693d22687474703a2f2f7777772e77332e6f72672f323030312f584d4c536368656d612d696e7374616e6365223e3c4572726f7249443e303c2f4572726f7249443e3c4d6f72653e66616c73653c2f4d6f72653e3c4e65787453746172745554433e323032352d31302d30312032333a35353a35323c2f4e65787453746172745554433e3c4d657373616765733e3c52657475726e4d6573736167653e3c49443e32303537353033373137313c2f49443e3c4d6573736167655554433e323032352d31302d30312032333a35353a34353c2f4d6573736167655554433e3c526563656976655554433e323032352d31302d30312032333a35353a34353c2f526563656976655554433e3c53494e3e3132363c2f53494e3e3c4d6f62696c6549443e3032303932323438534b59454537353c2f4d6f62696c6549443e3c5061796c6f6164204e616d653d22446967496e70324c6f222053494e3d2231323622204d494e3d223533223e3c4669656c64733e3c4669656c64204e616d653d224c61746974756465222056616c75653d2231313731323634222f3e3c4669656c64204e616d653d224c6f6e676974756465222056616c75653d222d35393532363938222f3e3c4669656c64204e616d653d225370656564222056616c75653d2230222f3e3c4669656c64204e616d653d2248656164696e67222056616c75653d22333631222f3e3c4669656c64204e616d653d224576656e7454696d65222056616c75653d2231373539333632393434222f3e3c2f4669656c64733e3c2f5061796c6f61643e3c526567696f6e4e616d653e43454c4c4d5442503c2f526567696f6e4e616d653e3c4f54414d65737361676553697a653e31363c2f4f54414d65737361676553697a653e3c2f52657475726e4d6573736167653e3c52657475726e4d6573736167653e3c49443e32303537353033373330383c2f49443e3c4d6573736167655554433e323032352d31302d30312032333a35353a34363c2f4d6573736167655554433e3c526563656976655554433e323032352d31302d30312032333a35353a34363c2f526563656976655554433e3c53494e3e3132363c2f53494e3e3c4d6f62696c6549443e3032303932323438534b59454537353c2f4d6f62696c6549443e3c5061796c6f6164204e616d653d22446967496e70324869222053494e3d2231323622204d494e3d223532223e3c4669656c64733e3c4669656c64204e616d653d224c61746974756465222056616c75653d2231313731323634222f3e3c4669656c64204e616d653d224c6f6e676974756465222056616c75653d222d35393532363938222f3e3c4669656c64204e616d653d225370656564222056616c75653d2230222f3e3c4669656c64204e616d653d2248656164696e67222056616c75653d22333631222f3e3c4669656c64204e616d653d224576656e7454696d65222056616c75653d2231373539333632393436222f3e3c2f4669656c64733e3c2f5061796c6f61643e3c526567696f6e4e616d653e43454c4c4d5442503c2f526567696f6e4e616d653e3c4f54414d65737361676553697a653e31363c2f4f54414d65737361676553697a653e3c2f52657475726e4d6573736167653e3c52657475726e4d6573736167653e3c49443e32303537353033373530323c2f49443e3c4d6573736167655554433e323032352d31302d30312032333a35353a34393c2f4d6573736167655554433e3c526563656976655554433e323032352d31302d30312032333a35353a34393c2f526563656976655554433e3c53494e3e3132363c2f53494e3e3c4d6f62696c6549443e3032303932323438534b59454537353c2f4d6f62696c6549443e3c5061796c6f6164204e616d653d22446967496e70324c6f222053494e3d2231323622204d494e3d223533223e3c4669656c64733e3c4669656c64204e616d653d224c61746974756465222056616c75653d2231313731323634222f3e3c4669656c64204e616d653d224c6f6e676974756465222056616c75653d222d35393532363938222f3e3c4669656c64204e616d653d225370656564222056616c75653d2230222f3e3c4669656c64204e616d653d2248656164696e67222056616c75653d22333631222f3e3c4669656c64204e616d653d224576656e7454696d65222056616c75653d2231373539333632393438222f3e3c2f4669656c64733e3c2f5061796c6f61643e3c526567696f6e4e616d653e43454c4c4d5442503c2f526567696f6e4e616d653e3c4f54414d65737361676553697a653e31363c2f4f54414d65737361676553697a653e3c2f52657475726e4d6573736167653e3c52657475726e4d6573736167653e3c49443e32303537353033373639363c2f49443e3c4d6573736167655554433e323032352d31302d30312032333a35353a35323c2f4d6573736167655554433e3c526563656976655554433e323032352d31302d30312032333a35353a35323c2f526563656976655554433e3c53494e3e3132363c2f53494e3e3c4d6f62696c6549443e3032303932323438534b59454537353c2f4d6f62696c6549443e3c5061796c6f6164204e616d653d22446967496e70324869222053494e3d2231323622204d494e3d223532223e3c4669656c64733e3c4669656c64204e616d653d224c61746974756465222056616c75653d2231313731323634222f3e3c4669656c64204e616d653d224c6f6e676974756465222056616c75653d222d35393532363939222f3e3c4669656c64204e616d653d225370656564222056616c75653d2230222f3e3c4669656c64204e616d653d2248656164696e67222056616c75653d22333631222f3e3c4669656c64204e616d653d224576656e7454696d65222056616c75653d2231373539333632393531222f3e3c2f4669656c64733e3c2f5061796c6f61643e3c526567696f6e4e616d653e43454c4c4d5442503c2f526567696f6e4e616d653e3c4f54414d65737361676553697a653e31363c2f4f54414d65737361676553697a653e3c2f52657475726e4d6573736167653e3c2f4d657373616765733e3c4e657874537461727449443e2d313c2f4e657874537461727449443e3c2f47657452657475726e4d65737361676573526573756c743e"

def on_connect(client, userdata, flags, rc):
    """Callback for when the client connects to the broker."""
    if rc == 0:
        print(f"✅ Connected to MQTT broker at {MQTT_BROKER_HOST}:{MQTT_PORT}")
    else:
        print(f"❌ Failed to connect to MQTT broker, return code: {rc}")
        sys.exit(1)

def on_publish(client, userdata, mid):
    """Callback for when a message is published."""
    print(f"✅ Message published successfully (mid: {mid})")

def decode_and_preview_hex(hex_string):
    """Decode hex string and show a preview of the XML."""
    try:
        xml_bytes = bytes.fromhex(hex_string)
        xml_string = xml_bytes.decode('utf-8')
        
        # Show preview (first 300 chars)
        preview_length = 300
        if len(xml_string) > preview_length:
            preview = xml_string[:preview_length] + "..."
        else:
            preview = xml_string
            
        print("\n=== XML Data Preview ===")
        print(preview)
        print(f"\nTotal XML size: {len(xml_string)} characters")
        print(f"Hex string size: {len(hex_string)} characters")
        print("=" * 50)
        
        return xml_bytes
    except Exception as e:
        print(f"❌ Error decoding hex string: {e}")
        return None

def main():
    """Main function to send hex data to MQTT."""
    print("=" * 50)
    print("MQTT Test Sender for SkyWave XML Data")
    print("=" * 50)
    print(f"MQTT Broker: {MQTT_BROKER_HOST}:{MQTT_PORT}")
    print(f"MQTT Topic: {MQTT_TOPIC}")
    print(f"Client ID: {MQTT_CLIENT_ID}")
    print("=" * 50)
    
    # Decode and preview the data
    xml_bytes = decode_and_preview_hex(HEX_DATA)
    if xml_bytes is None:
        sys.exit(1)
    
    # Create MQTT client
    client = mqtt.Client(client_id=MQTT_CLIENT_ID)
    client.on_connect = on_connect
    client.on_publish = on_publish
    
    try:
        # Connect to broker
        print(f"\nConnecting to MQTT broker at {MQTT_BROKER_HOST}:{MQTT_PORT}...")
        client.connect(MQTT_BROKER_HOST, MQTT_PORT, 60)
        
        # Start network loop in background
        client.loop_start()
        
        # Wait a moment for connection to establish
        import time
        time.sleep(1)
        
        # Publish the hex string (matching Go service behavior)
        print(f"\nPublishing hex-encoded data to topic '{MQTT_TOPIC}'...")
        result = client.publish(MQTT_TOPIC, HEX_DATA, qos=0, retain=False)
        
        # Wait for publish to complete
        result.wait_for_publish()
        
        # Give it a moment to complete
        time.sleep(1)
        
        print("\n✅ Test data sent successfully!")
        print(f"   Topic: {MQTT_TOPIC}")
        print(f"   Payload size: {len(HEX_DATA)} bytes (hex-encoded)")
        print(f"   XML size: {len(xml_bytes)} bytes (decoded)")
        
    except Exception as e:
        print(f"\n❌ Error: {e}")
        sys.exit(1)
    finally:
        client.loop_stop()
        client.disconnect()
        print("\nDisconnected from MQTT broker")

if __name__ == "__main__":
    main()
