package data

import (
	"bytes"
	"encoding/json"
	"fmt"
	"net/http"
	"os"
	"recursoconfiable/features/recursoconfiable_integrator/models"
	"regexp"
	"strings"
	"time"
)

type ElasticLogData struct {
	Client       string `json:"client"`
	IMEI         string `json:"imei"`
	SoapEnvelope string `json:"soap-envelope"`
	Time         string `json:"time"`
	StatusCode   int    `json:"status-code"`
	StatusText   string `json:"status-text"`
}

func sendToElastic(logData ElasticLogData, customerName string) error {
	// Obtener la URL base de Elasticsearch
	elasticBaseURL := os.Getenv("ELASTIC_URL")
	if elasticBaseURL == "" {
		elasticBaseURL = "http://elasticserver.dwim.mx:9200"
	}

	// Convertir customerName a snake_case en minúsculas
	customerName = toSnakeCase(customerName)

	// Construir la URL dinámica del índice
	indexName := fmt.Sprintf("%s_rc", customerName) // El índice será {customerName}_index
	elasticURL := fmt.Sprintf("%s/%s/_doc", elasticBaseURL, indexName)

	// Debug: Verificar datos antes de enviar
	fmt.Printf("Elastic URL: %s\n", elasticURL)
	fmt.Printf("Log Data: %+v\n", logData)

	// Convertir los datos a JSON
	jsonData, err := json.Marshal(logData)
	if err != nil {
		fmt.Printf("Error marshaling log data: %v\n", err)
		return fmt.Errorf("error marshaling log data: %v", err)
	}

	// Debug: Ver JSON generado
	fmt.Printf("JSON Data to send: %s\n", string(jsonData))

	// Crear la solicitud HTTP
	req, err := http.NewRequest("POST", elasticURL, bytes.NewBuffer(jsonData))
	if err != nil {
		fmt.Printf("Error creating elastic request: %v\n", err)
		return fmt.Errorf("error creating elastic request: %v", err)
	}

	req.Header.Set("Content-Type", "application/json")

	// Enviar la solicitud a Elasticsearch
	client := &http.Client{}
	resp, err := client.Do(req)
	if err != nil {
		fmt.Printf("Error sending to Elasticsearch: %v\n", err)
		return fmt.Errorf("error sending to elastic: %v", err)
	}
	defer resp.Body.Close()

	// Verificar el código de respuesta
	if resp.StatusCode >= 400 {
		fmt.Printf("Elastic error: status code %d\n", resp.StatusCode)
		return fmt.Errorf("elastic error: status code %d", resp.StatusCode)
	}

	fmt.Printf("Data successfully sent to Elasticsearch with status code %d\n", resp.StatusCode)
	return nil
}

func toSnakeCase(input string) string {
	// Reemplazar espacios por guiones bajos
	re := regexp.MustCompile(`\s+`)
	snake := re.ReplaceAllString(strings.TrimSpace(input), "_")

	// Convertir a minúsculas
	return strings.ToLower(snake)
}

func SendSOAPRequest(url, plates, token, dataStr string) error {
	var data models.JonoModel
	// Deserializar el JSON en la estructura ComplementData
	err := json.Unmarshal([]byte(dataStr), &data)
	if err != nil {
		return fmt.Errorf("error deserializing JSON: %v", err)
	}

	imei := data.IMEI

	var packet models.DataPacket
	for _, p := range data.ListPackets {
		packet = p
		break // Tomar solo el primer paquete
	}

	eventCode := fmt.Sprintf("%d", packet.EventCode.Code)
	latitude := fmt.Sprintf("%f", packet.Latitude)
	longitude := fmt.Sprintf("%f", packet.Longitude)
	altitude := fmt.Sprintf("%d", packet.Altitude)
	speed := fmt.Sprintf("%d", packet.Speed)
	direction := fmt.Sprintf("%d", packet.Extras.Direction)
	date := packet.Datetime.Format(time.RFC3339)
	battery := fmt.Sprintf("%d", 100)
	humidity := fmt.Sprintf("%d", 0)
	ignition := "True"
	odometer := fmt.Sprintf("%d", 0)
	serial_number := fmt.Sprintf("%d", 0)
	shipment := fmt.Sprintf("%d", 0)
	temperature := fmt.Sprintf("%d", 0)
	vehicle_type := ""
	vehicle_brand := ""
	vehicle_model := ""

	CUSTOMER_ID := os.Getenv("CUSTOMER_ID")
	CUSTOMER_NAME := os.Getenv("CUSTOMER_NAME")

	body := fmt.Sprintf(`<?xml version="1.0" encoding="UTF-8"?>
	<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns0="http://tempuri.org/">
	  <SOAP-ENV:Header/>
	  <SOAP-ENV:Body>
		<ns0:GPSAssetTracking>
		  <ns0:token>%s</ns0:token>
		  <ns0:events>
			<ns0:Event>
			  <ns0:altitude>%s</ns0:altitude>
			  <ns0:asset>%s</ns0:asset>
			  <ns0:code>%s</ns0:code>
			  <ns0:course>%s</ns0:course>
			  <ns0:latitude>%s</ns0:latitude>
			  <ns0:longitude>%s</ns0:longitude>
			  <ns0:plates>%s</ns0:plates>
			  <ns0:date>%s</ns0:date>
			  <ns0:speed>%s</ns0:speed>
			  <ns0:customer>
				<ns0:id>%s</ns0:id>
				<ns0:name>%s</ns0:name>
			  </ns0:customer>
			</ns0:Event>
		  </ns0:events>
		</ns0:GPSAssetTracking>
	  </SOAP-ENV:Body>
	</SOAP-ENV:Envelope>`, token, altitude, plates, eventCode, direction, latitude, longitude, plates, date, speed, CUSTOMER_ID, CUSTOMER_NAME)

	req, err := http.NewRequest("POST", url, bytes.NewBuffer([]byte(body)))
	if err != nil {
		fmt.Printf("Error creating SOAP request: %v\n", err)
		return fmt.Errorf("error creating SOAP request: %v", err)
	}

	req.Header.Add("Content-Type", "text/xml")
	req.Header.Add("SOAPAction", "http://tempuri.org/IRCService/GPSAssetTracking")

	client := &http.Client{}
	resp, err := client.Do(req)
	if err != nil {
		fmt.Printf("Error sending SOAP request: %v\n", err)
		return fmt.Errorf("error sending SOAP request: %v", err)
	}
	defer resp.Body.Close()

	clientID := os.Getenv("CLIENT_ID")

	// Send log to Elasticsearch
	logData := ElasticLogData{
		Client:       clientID,
		IMEI:         imei,
		SoapEnvelope: body,
		Time:         time.Now().Format(time.RFC3339),
		StatusCode:   resp.StatusCode,
		StatusText:   resp.Status,
	}

	if err := sendToElastic(logData, CUSTOMER_NAME); err != nil {
		fmt.Printf("Error sending to Elasticsearch: %v\n", err)
	}

	return nil
}
