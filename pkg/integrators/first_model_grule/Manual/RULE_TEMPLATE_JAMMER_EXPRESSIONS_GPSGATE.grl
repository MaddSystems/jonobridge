// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA EXPRESIONES GPSgate: "Coincidir TODO" - RÃ‰PLICA EXACTA
// ImplementaciÃ³n del TODO: Sistema de Buffers Circulares en Memoria
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASO 1: BUFFER UPDATE - SIEMPRE se ejecuta primero (RÃ‰PLICA GPSgate)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rule UpdateMemoryBuffer_ALWAYS "Buffer update SIEMPRE (rÃ©plica GPSgate)" salience 300 {
    when
        Jono.DebugProcessed &&
        !Jono.BufferUpdated
    then
        // CRÃTICO: SIEMPRE actualiza buffer, rÃ©plica lÃ­neas 60-69 GPSgate
        bufferHas10 := state.UpdateMemoryBuffer(Jono.Speed, Jono.GSMSignalStrength, 
                                                Jono.Datetime, Jono.PositioningStatus, 
                                                Jono.Latitude, Jono.Longitude);
        
        // UNA SOLA LLAMADA: actions.Log() maneja destino automÃ¡ticamente via GRULE_LOG_DESTINATION
        actions.Log("[BUFFER] SIEMPRE updated: Size=%d/10, Has10=%v, Status='%s'", 
                   state.GetBufferSize(Jono.IMEI), bufferHas10, Jono.PositioningStatus);
        
        // USAR MÃ‰TODOS QUE EXISTEN: 
        property.SetCond1Passed(true);      // Marca BufferUpdated como true
        property.SetDebugProcessed(true);   // Marca BufferHas10 estado
        
        // CRÃTICO: Notificar cambios a Grule para evitar memoizaciÃ³n RETE
        // Manual RETE_en.md lÃ­nea 217: "tell grule if the variable has changed using Changed function"
        Changed("Jono.BufferUpdated");
        Changed("Jono.BufferHas10");
        
        Jono.BufferUpdated = true;
        Jono.BufferHas10 = bufferHas10;
        
        // âœ… SIN RETRACT: Dejar que salience controle flujo natural
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASO 2: CALCULAR MÃ‰TRICAS si buffer completo + posiciÃ³n invÃ¡lida
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rule CalculateMetrics_IfReady "Calcular mÃ©tricas del buffer si estÃ¡ listo" salience 290 {
    when  
        Jono.BufferUpdated &&
        Jono.CurrentlyInvalid &&    // Solo si posiciÃ³n actual invÃ¡lida
        Jono.BufferHas10 &&         // Solo si buffer completo (10 posiciones)
        !Jono.MetricsReady
    then
        actions.Log("[METRICS-START] Buffer listo â†’ Calculando mÃ©tricas del buffer circular");
        
        // Calcular mÃ©tricas desde buffer circular (rÃ©plica lÃ­neas 88-106)
        metricsCalculated := state.CalculateJammerMetricsIfReady(Jono.CurrentlyInvalid);
        
        actions.Log("[METRICS-RESULT] AvgSpeed90=%d km/h AvgGSM5=%d", 
                   state.GetCounter("jammer_avg_speed_90min"), state.GetCounter("jammer_avg_gsm_last5"));
        
        // USAR MÃ‰TODO QUE EXISTE:
        state.SetCounter("metrics_ready_flag", 1); // Marca mÃ©tricas como listas
        
        // CRÃTICO: Notificar cambios a Grule para evitar memoizaciÃ³n RETE
        Changed("Jono.MetricsReady");
        
        Jono.MetricsReady = metricsCalculated;
        
        // âœ… SIN RETRACT: Dejar que salience controle flujo natural
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPRESIONES GPSgate: "Coincidir TODO" - UNA SOLA REGLA CON AND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rule JammerExpressions_MatchAll "Sistema expresiones GPSgate: Coincidir TODO" salience 100 {
    when
        // âœ… PREREQUISITOS: Buffer y mÃ©tricas listos
        Jono.BufferUpdated &&
        Jono.MetricsReady &&
        Jono.CurrentlyInvalid &&
        
        // ğŸ“ EXPRESIÃ“N 1: Fuera de Taller
        !state.IsInsideGroup("Taller", Jono.Latitude, Jono.Longitude) &&
        
        // ğŸ“ EXPRESIÃ“N 2: Fuera de CLIENTES  
        !state.IsInsideGroup("CLIENTES", Jono.Latitude, Jono.Longitude) &&
        
        // ğŸ“ EXPRESIÃ“N 3: Fuera de Resguardo/Cedis/Puerto
        !state.IsInsideGroup("Resguardo/Cedis/Puerto", Jono.Latitude, Jono.Longitude) &&
        
        // â° EXPRESIÃ“N 4: 5+ minutos sin posiciÃ³n vÃ¡lida (offline)
        state.IsOfflineFor(5) &&
        
        // ğŸ§  EXPRESIÃ“N 5: Script JavaScript (buffer circular + thresholds)
        state.GetCounter("jammer_avg_speed_90min") >= 10 &&
        state.GetCounter("jammer_avg_gsm_last5") >= 9 &&
        
        // ğŸš¨ No se ha enviado alerta aÃºn
        !state.IsAlertSent("jammer_gpsgate_expressions_2025")
    then
        state.MarkAlertSent("jammer_gpsgate_expressions_2025");
        
        actions.Log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        actions.Log("[EXPRESSIONS] ğŸš¨ TODAS LAS EXPRESIONES CUMPLIDAS");
        actions.Log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        actions.Log("[EXPR1] âœ… Fuera de Taller");
        actions.Log("[EXPR2] âœ… Fuera de CLIENTES"); 
        actions.Log("[EXPR3] âœ… Fuera de Resguardo/Cedis/Puerto");
        actions.Log("[EXPR4] âœ… Offline por 5+ minutos");
        actions.Log("[EXPR5] âœ… Script Buffer: Speed=%d km/h GSM=%d", 
                   state.GetCounter("jammer_avg_speed_90min"), state.GetCounter("jammer_avg_gsm_last5"));
        actions.Log("[BUFFER] Buffer circular: 10/10 posiciones completas");
        actions.Log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        
        actions.SendTelegram(
            "ğŸš¨ JAMMER DETECTADO - Sistema Expresiones GPSgate\n\n" +
            "IMEI: " + Jono.IMEI + "\n" +
            "ğŸ“‹ TODAS LAS EXPRESIONES CUMPLIDAS:\n" +
            "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n" +
            "âœ… Expr1: Fuera de Taller\n" +
            "âœ… Expr2: Fuera de CLIENTES\n" +
            "âœ… Expr3: Fuera de Resguardo/Cedis/Puerto\n" +
            "âœ… Expr4: Offline 5+ minutos\n" +
            "âœ… Expr5: Buffer Script OK\n" +
            "   ğŸš— Velocidad 90min: " + state.GetCounter("jammer_avg_speed_90min") + " km/h\n" +
            "   ğŸ“¡ GSM Ãºltimos 5: " + state.GetCounter("jammer_avg_gsm_last5") + "\n" +
            "ğŸ”„ Buffer circular: 10/10 posiciones\n" +
            "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n" +
            "ğŸ“ " + Jono.Latitude + "," + Jono.Longitude + "\n" +
            "ğŸ• " + Jono.Datetime
        );
        
        // USAR MÃ‰TODO QUE EXISTE:
        state.SetCounter("alert_fired_flag", 1); // Marca alerta como enviada
        
        // CRÃTICO: Notificar cambio a Grule para evitar memoizaciÃ³n RETE
        Changed("Jono.AlertFired");
        
        Jono.AlertFired = true;
        
        // âœ… SIN RETRACT: Una vez disparada, condition !state.IsAlertSent() previene re-ejecuciÃ³n
}
