// ============================================================================
// REGLA JAMMER DETECTION - Sistema Universal
// ============================================================================
// Detecta seÃ±ales de jamming GPS analizando el comportamiento de la seÃ±al
// NO necesita geofences - analiza parÃ¡metros GPS directamente
// ============================================================================

rule IncrementarContadorJammerMercury "Incrementar contador de seÃ±al jammer (Cond 1)" salience 200 {
    when
        // CondiciÃ³n 1: Detectar seÃ±al irregular (GSM > 0, pero GPS = 0 o seÃ±al dÃ©bil)
        Jono.GsmSignal > 0 &&
        (Jono.SatelliteNumber == 0 || Jono.SatelliteNumber < 4)
    then
        // âœ… AuditorÃ­a universal: captura automÃ¡tica del contexto
        actions.Audit("IncrementarContadorJammerMercury", "SeÃ±al GPS irregular detectada - posible jamming", 200, false);
        
        property.SetCond1Passed(true);
        memoryBuffer.IncrementarContadorJammer();
        actions.Log("Jammer Cond1 PASSED - IMEI: %s, GSM: %v, Sats: %v", 
            Jono.IMEI, Jono.GsmSignal, Jono.SatelliteNumber);
        Retract("IncrementarContadorJammerMercury");
}

rule CondicionContadorMinimo "Verificar contador mÃ­nimo de eventos jammer (Cond 2)" salience 190 {
    when
        property.Cond1Passed == true &&
        memoryBuffer.ContadorJammer >= 3
    then
        // âœ… AuditorÃ­a universal
        actions.Audit("CondicionContadorMinimo", "Contador de jamming alcanzÃ³ umbral mÃ­nimo", 190, false);
        
        property.SetCond2Passed(true);
        actions.Log("Jammer Cond2 PASSED - Contador: %v", memoryBuffer.ContadorJammer);
        Retract("CondicionContadorMinimo");
}

rule RevisarSiYaFueReportado "Verificar si ya fue reportado en 24h (Cond 3)" salience 180 {
    when
        property.Cond2Passed == true &&
        persistentState.FueReportadoJammer24h(Jono.IMEI) == false
    then
        // âœ… AuditorÃ­a universal
        actions.Audit("RevisarSiYaFueReportado", "Jammer no reportado en Ãºltimas 24h - proceder con alerta", 180, false);
        
        property.SetCond3Passed(true);
        actions.Log("Jammer Cond3 PASSED - No reportado previamente");
        Retract("RevisarSiYaFueReportado");
}

rule EnviarAlertaTelegram "Enviar alerta de jammer por Telegram (Cond 4)" salience 170 {
    when
        property.Cond3Passed == true
    then
        // ðŸš¨ ALERTA: alertFired = true (captura completa del contexto)
        actions.Audit("EnviarAlertaTelegram", "ðŸš¨ ALERTA DE JAMMING GPS CONFIRMADA", 170, true);
        
        property.SetCond4Passed(true);
        
        actions.SendTelegram(
            "ðŸš¨ *ALERTA: Jamming GPS Detectado*\n" +
            "IMEI: " + Jono.IMEI + "\n" +
            "Eventos: " + memoryBuffer.ContadorJammer + "\n" +
            "SeÃ±al GSM: " + Jono.GsmSignal + "\n" +
            "SatÃ©lites: " + Jono.SatelliteNumber
        );
        
        persistentState.MarcarReportadoJammer(Jono.IMEI);
        memoryBuffer.ResetearContadorJammer();
        
        actions.Log("âœ… Jammer Cond4 PASSED - Alerta enviada exitosamente");
        Retract("EnviarAlertaTelegram");
}

rule ResetearPropertiesAlFinal "Resetear properties al finalizar ciclo" salience 1 {
    when
        property.Cond1Passed == true ||
        property.Cond2Passed == true ||
        property.Cond3Passed == true ||
        property.Cond4Passed == true
    then
        // âœ… AuditorÃ­a universal
        actions.Audit("ResetearPropertiesAlFinal", "Reseteo de condiciones para prÃ³ximo ciclo", 1, false);
        
        property.ResetAll();
        actions.Log("Properties reseteadas para IMEI: %s", Jono.IMEI);
        Retract("ResetearPropertiesAlFinal");
}
