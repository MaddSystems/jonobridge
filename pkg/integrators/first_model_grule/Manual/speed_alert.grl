// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// name: Speed Alert - Movimiento Detectado
// category: Alerts  
// description: Dispara una alerta por Telegram cuando el veh√≠culo est√° en movimiento (velocidad > 20 km/h)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

rule SpeedAlert "Alerta cuando est√° en movimiento (velocidad > 20 km/h)" salience 100 {
    when
        Jono.Speed > 20 &&
        (Jono.PositioningStatus == "A" || Jono.PositioningStatus == "true") &&
        property.Cond1Processed == false
    then
        // Log del evento
        actions.Log("üö® ALERTA DE MOVIMIENTO - IMEI: " + Jono.IMEI);
        actions.Log("üìç Ubicaci√≥n: Lat=" + Jono.Latitude + ", Lon=" + Jono.Longitude);
        actions.Log("‚è±Ô∏è  Hora: " + Jono.Datetime.String());
        actions.Log("üìè Velocidad: " + Jono.Speed + " km/h");
        
        // Enviar alerta por Telegram
        actions.SendTelegram(
            "üö® ALERTA DE MOVIMIENTO\n" +
            "IMEI: " + Jono.IMEI + "\n" +
            "Velocidad: " + Jono.Speed + " km/h\n" +
            "Ubicaci√≥n: (" + Jono.Latitude + ", " + Jono.Longitude + ")\n" +
            "Hora: " + Jono.Datetime.String()
        );
        
        // AUDITOR√çA: Marcar flags para que se registre en la base de datos
        property.SetCond1Processed(true);  // Marca que se proces√≥ (para contar steps)
        property.SetCond1Passed(true);      // Marca que pas√≥ exitosamente (para status)
        Jono.AlertFired = true;             // Marca que hubo alerta (para alert_fired column)
}
