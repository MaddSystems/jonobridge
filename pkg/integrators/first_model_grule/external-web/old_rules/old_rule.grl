// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// name: Old-Jammer-Real 
// category: Jammer Detection
// description: Sistema de detecciÃ³n de inhibidor GPS usando buffer circular de 10 posiciones
//              Replica exacta del algoritmo GPSgate con expresiones de geofencing y mÃ©tricas
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALGORITMO GPSgate (LÃ­neas 56-84):
// 1. SIEMPRE actualiza buffer circular (lÃ­neas 60-69)
// 2. SIEMPRE calcula isValid (lÃ­neas 70-77)  
// 3. EVALÃšA solo si posiciÃ³n actual invÃ¡lida (lÃ­nea 82)
//    - Si buffer completo (10 posiciones): Calcula mÃ©tricas y evalÃºa thresholds
//    - Si buffer incompleto: Solo registra y continÃºa
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASO 1: BUFFER UPDATE - SIEMPRE se ejecuta primero
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rule JammerReal_BufferUpdate "Buffer update SIEMPRE (rÃ©plica GPSgate)" salience 300 {
    when
        Jono.DebugProcessed &&
        !Jono.BufferUpdated
    then
        // CRÃTICO: SIEMPRE actualiza buffer, independiente de posiciÃ³n vÃ¡lida/invÃ¡lida
        Jono.BufferHas10 = state.UpdateMemoryBuffer(Jono.Speed, Jono.GSMSignalStrength, 
                                                     Jono.Datetime, Jono.PositioningStatus, 
                                                     Jono.Latitude, Jono.Longitude);
        
        actions.Log("[JAMMER-REAL-BUFFER] SIEMPRE updated: Size=" + state.GetBufferSize(Jono.IMEI) + "/10, Has10=" + Jono.BufferHas10 + ", Status=" + Jono.PositioningStatus);
        
        // Notificar cambios a Grule para evitar memoizaciÃ³n RETE
        Changed("Jono.BufferUpdated");
        Changed("Jono.BufferHas10");
        
        Jono.BufferUpdated = true;
        
        // Sincronizar flags al wrapper para auditorÃ­a de progreso
        property.SetBufferUpdated(true);
        property.SetBufferHas10(Jono.BufferHas10);
        
        // Registrar en auditorÃ­a
        actions.Audit("JammerReal_BufferUpdate", "Buffer circular actualizado", 300, false);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASO 2: CALCULAR MÃ‰TRICAS - Solo si buffer completo y posiciÃ³n invÃ¡lida
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rule JammerReal_CalculateMetrics "Calcular mÃ©tricas del buffer si estÃ¡ listo" salience 290 {
    when  
        Jono.BufferUpdated &&
        Jono.CurrentlyInvalid &&    // Solo si posiciÃ³n actual invÃ¡lida (rÃ©plica lÃ­nea 82)
        Jono.BufferHas10 &&         // Solo si buffer completo (10 posiciones)
        !Jono.MetricsReady
    then
        actions.Log("[JAMMER-REAL-METRICS] Buffer listo â†’ Calculando mÃ©tricas del buffer circular");
        
        // Calcular mÃ©tricas desde buffer circular (rÃ©plica lÃ­neas 88-106)
        state.CalculateJammerMetricsIfReady(Jono.CurrentlyInvalid);
        
        actions.Log("[JAMMER-REAL-METRICS] AvgSpeed90: " + state.GetCounter("jammer_avg_speed_90min") + " km/h");
        actions.Log("[JAMMER-REAL-METRICS] AvgGSM5: " + state.GetCounter("jammer_avg_gsm_last5"));
        
        // Notificar cambios
        Changed("Jono.MetricsReady");
        
        Jono.MetricsReady = true;
        
        // Sincronizar flag al wrapper para auditorÃ­a de progreso
        property.SetMetricsReady(true);
        
        // Registrar en auditorÃ­a
        actions.Audit("JammerReal_CalculateMetrics", "MÃ©tricas calculadas desde buffer", 290, false);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASO 3: EVALUAR EXPRESIONES - DetecciÃ³n de Jammer Real
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rule JammerReal_Detection "DetecciÃ³n de Jammer Real con todas las expresiones" salience 100 {
    when
        // âœ… PREREQUISITOS: Buffer y mÃ©tricas listos
        Jono.BufferUpdated &&
        Jono.MetricsReady &&
        Jono.CurrentlyInvalid &&
        
        // ğŸ“ EXPRESIÃ“N 1: Fuera de Taller
        !state.IsInsideGroup("Taller", Jono.Latitude, Jono.Longitude) &&
        
        // ğŸ“ EXPRESIÃ“N 2: Fuera de CLIENTES  
        !state.IsInsideGroup("CLIENTES", Jono.Latitude, Jono.Longitude) &&
        
        // ğŸ“ EXPRESIÃ“N 3: Fuera de Resguardo/Cedis/Puerto
        !state.IsInsideGroup("Resguardo/Cedis/Puerto", Jono.Latitude, Jono.Longitude) &&
        
        // â° EXPRESIÃ“N 4: 5+ minutos sin posiciÃ³n vÃ¡lida (offline)
        state.IsOfflineFor(5) &&
        
        // ğŸ§  EXPRESIÃ“N 5: Script JavaScript (buffer circular + thresholds)
        state.GetCounter("jammer_avg_speed_90min") >= 10 &&
        state.GetCounter("jammer_avg_gsm_last5") >= 9 &&
        
        // ğŸš¨ No se ha enviado alerta aÃºn
        !state.IsAlertSent("jammer_real_mercury_2025")
    then
        state.MarkAlertSent("jammer_real_mercury_2025");
        
        actions.Log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        actions.Log("[JAMMER-REAL] ğŸš¨ JAMMER DETECTADO - TODAS LAS EXPRESIONES CUMPLIDAS");
        actions.Log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        actions.Log("[EXPR1] âœ… Fuera de Taller");
        actions.Log("[EXPR2] âœ… Fuera de CLIENTES"); 
        actions.Log("[EXPR3] âœ… Fuera de Resguardo/Cedis/Puerto");
        actions.Log("[EXPR4] âœ… Offline por 5+ minutos");
        actions.Log("[EXPR5] âœ… Script Buffer OK");
        actions.Log("[METRICS] Speed 90min: " + state.GetCounter("jammer_avg_speed_90min") + " km/h");
        actions.Log("[METRICS] GSM Ãºltimos 5: " + state.GetCounter("jammer_avg_gsm_last5"));
        actions.Log("[BUFFER] Buffer Size: " + state.GetBufferSize(Jono.IMEI) + "/10 posiciones");
        actions.Log("[IMEI] " + Jono.IMEI);
        actions.Log("[LOCATION] Lat: " + Jono.Latitude + ", Lon: " + Jono.Longitude);
        actions.Log("[TIME] " + Jono.Datetime.String());
        actions.Log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        
        // Enviar alerta por Telegram (concatenaciÃ³n directa sin variables intermedias)
        actions.SendTelegram(
            "ğŸš¨ JAMMER REAL DETECTADO - Sistema Mercury\n\n" +
            "IMEI: " + Jono.IMEI + "\n" +
            "ğŸ“‹ TODAS LAS EXPRESIONES CUMPLIDAS:\n" +
            "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n" +
            "âœ… Expr1: Fuera de Taller\n" +
            "âœ… Expr2: Fuera de CLIENTES\n" +
            "âœ… Expr3: Fuera de Resguardo/Cedis/Puerto\n" +
            "âœ… Expr4: Offline 5+ minutos\n" +
            "âœ… Expr5: Buffer Script OK\n" +
            "   ğŸš— Velocidad 90min: " + state.GetCounter("jammer_avg_speed_90min") + " km/h\n" +
            "   ğŸ“¡ GSM Ãºltimos 5: " + state.GetCounter("jammer_avg_gsm_last5") + "\n" +
            "ğŸ”„ Buffer Size: " + state.GetBufferSize(Jono.IMEI) + "/10 posiciones\n" +
            "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n" +
            "ğŸ“ Lat: " + Jono.Latitude + "\n" +
            "ğŸ“ Lon: " + Jono.Longitude + "\n" +
            "ğŸ• " + Jono.Datetime.String()
        );
        
        // Marcar alerta disparada
        Jono.AlertFired = true;
        Changed("Jono.AlertFired");
        
        // Sincronizar flag al wrapper para auditorÃ­a de progreso
        property.SetAlertFired(true);
        
        // ğŸ†• NUEVO SISTEMA: AuditorÃ­a universal con snapshot automÃ¡tico
        actions.Audit("JammerReal_Detection", "Jammer Real detectado con todas las expresiones", 100, true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASO 4: SKIP EVALUATION - Si posiciÃ³n vÃ¡lida, solo continuar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rule JammerReal_SkipIfValid "Skip evaluaciÃ³n si posiciÃ³n vÃ¡lida (rÃ©plica GPSgate lÃ­nea 115)" salience 280 {
    when
        Jono.BufferUpdated &&
        !Jono.CurrentlyInvalid &&      // PosiciÃ³n vÃ¡lida (GPS OK)
        !Jono.EvaluationSkipped
    then
        actions.Log("[JAMMER-REAL-SKIP] PosiciÃ³n vÃ¡lida â†’ No evalÃºa mÃ©tricas (rÃ©plica GPSgate lÃ­nea 115)");
        
        // Notificar cambio
        Changed("Jono.EvaluationSkipped");
        
        Jono.EvaluationSkipped = true;
        
        // Sincronizar flag al wrapper para auditorÃ­a de progreso
        property.SetEvaluationSkipped(true);
        
        // Registrar en auditorÃ­a
        actions.Audit("JammerReal_SkipIfValid", "EvaluaciÃ³n omitida - posiciÃ³n vÃ¡lida", 280, false);
}
