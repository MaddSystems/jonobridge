{% extends "base.html" %}

{% block title %}{{ title }} - Grule Engine{% endblock %}

{% block content %}

<!-- Header -->
<div class="header">
    <h1>
        {% if rule %}
            <i class="fas fa-edit"></i> Editar Regla
        {% else %}
            <i class="fas fa-plus-circle"></i> Nueva Regla
        {% endif %}
    </h1>
    <a href="/" class="back-link">
        <i class="fas fa-arrow-left"></i> Volver al listado
    </a>
</div>

<!-- Main Content -->
<div class="main-content">
    <!-- Left: Form -->
    <div class="form-card">
        <form method="post" id="ruleForm">
            <!-- Nombre -->
            <div class="form-group mb-4">
                <label for="name" class="form-label">
                    <i class="fas fa-tag"></i> Nombre de la Regla *
                </label>
                <input type="text" class="form-control" id="name" name="name" required 
                       value="{{ rule.name if rule else '' }}" 
                       placeholder="Ej: ExcesoVelocidad120">
                <div class="help-text">
                    <i class="fas fa-info-circle"></i> Identifica única de la regla en el sistema
                </div>
            </div>

            <!-- Prioridad -->
            <div class="form-group mb-4">
                <label for="priority" class="form-label">
                    <i class="fas fa-layer-group"></i> Prioridad (Priority)
                </label>
                <input type="number" class="form-control" id="priority" name="priority" 
                       value="{{ rule.priority if rule else 10 }}" 
                       min="1" max="1000">
                <div class="help-text">
                    <i class="fas fa-info-circle"></i> Valores altos = mayor prioridad de ejecución
                </div>
            </div>

            <!-- Estado -->
            <div class="form-group mb-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="active" name="active" {% if rule and rule.active %}checked{% endif %}>
                    <label class="form-check-label" for="active">
                        <i class="fas fa-power-off"></i> Regla activa
                    </label>
                </div>
                <div class="help-text">
                    Desactiva para pausar sin eliminar la regla
                </div>
            </div>

            <!-- Código GRL -->
            <div class="form-group mb-4">
                <label for="grl" class="form-label">
                    <i class="fas fa-code"></i> Código GRL *
                </label>
                <textarea class="form-control" id="grl" name="grl" required>{{ rule.grl if rule else '' }}</textarea>
                <div class="help-text">
                    <i class="fas fa-info-circle"></i> Grule Rule Language - sintaxis requiere validación
                </div>
            </div>
        </form>
    </div>

    <!-- Right: Templates Sidebar -->
    <div class="sidebar">
        <div class="form-card">
            <h5>
                <i class="fas fa-book"></i> Plantillas Rápidas
            </h5>
            <div class="templates-wrapper" id="templatesContainer">
                <!-- Se llena dinámicamente con JS -->
            </div>
        </div>
    </div>
</div>

<!-- Actions -->
<div class="form-actions">
    <button type="button" onclick="validateSyntax()" class="btn btn-secondary">
        <i class="fas fa-check-circle"></i> Validar Sintaxis
    </button>
    <button type="submit" form="ruleForm" class="btn btn-primary">
        <i class="fas fa-save"></i> Guardar Regla
    </button>
    <a href="/" class="btn btn-light">
        <i class="fas fa-times-circle"></i> Cancelar
    </a>
    {% if rule %}
    <form action="{{ url_for('delete_rule', rule_id=rule.id) }}" method="post" onsubmit="return confirm('¿Estás seguro de que quieres eliminar esta regla?');" style="display:inline;">
        <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash-alt"></i> Eliminar Regla
        </button>
    </form>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
    // Datos de plantillas (desde el backend)
    const templates = {{ templates_json | tojson }};

    // Agrupar por categoría
    const templatesByCategory = {};
    for (const [key, template] of Object.entries(templates)) {
        const category = template.category || 'Otros';
        if (!templatesByCategory[category]) {
            templatesByCategory[category] = [];
        }
        templatesByCategory[category].push({key, ...template});
    }

    // Renderizar plantillas
    function renderTemplates() {
        const container = document.getElementById('templatesContainer');
        container.innerHTML = '';

        for (const [category, items] of Object.entries(templatesByCategory)) {
            // Categoría
            const categoryDiv = document.createElement('div');
            categoryDiv.style.marginBottom = '0';

            const categoryTitle = document.createElement('div');
            categoryTitle.className = 'category-title';
            categoryTitle.textContent = category;
            categoryDiv.appendChild(categoryTitle);

            // Plantillas de la categoría
            for (const template of items) {
                const card = document.createElement('div');
                card.className = 'template-card';
                
                const header = document.createElement('div');
                header.className = 'template-header';
                header.innerHTML = '<i class="fas fa-caret-right"></i> ' + template.name;
                card.appendChild(header);
                
                const body = document.createElement('div');
                body.className = 'template-body';
                
                const desc = document.createElement('div');
                desc.className = 'template-desc';
                desc.textContent = template.description;
                body.appendChild(desc);
                
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'template-btn';
                btn.innerHTML = '<i class="fas fa-paste"></i> Usar plantilla';
                btn.onclick = function() {
                    applyTemplate(template.name, template.grl);
                };
                body.appendChild(btn);
                
                card.appendChild(body);
                categoryDiv.appendChild(card);
            }

            container.appendChild(categoryDiv);
        }
    }

    // Aplicar plantilla
    function applyTemplate(name, grl) {
        document.getElementById('name').value = name;
        document.getElementById('grl').value = grl;
        
        // Scroll al editor
        document.querySelector('.form-card').scrollIntoView({behavior: 'smooth'});
    }

    // Validar sintaxis
    async function validateSyntax() {
        const grl = document.getElementById('grl').value;
        if (!grl.trim()) {
            alert('⚠️ El código GRL no puede estar vacío');
            return;
        }

        try {
            const response = await fetch('/api/validate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({grl})
            });
            
            const data = await response.json();
            
            if (data.valid) {
                alert('✅ ¡Sintaxis válida!');
            } else {
                alert(`❌ Error de sintaxis:\n\n${data.error}`);
            }
        } catch (error) {
            alert(`❌ Error: ${error.message}`);
        }
    }

    // Inicializar plantillas
    renderTemplates();
</script>
{% endblock %}