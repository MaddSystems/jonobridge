// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// name: Jammer-Wargames-DEFCON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rule DEFCON0_Surveillance "DEFCON 0: Surveillance" salience 1000 {
    when
        !IncomingPacket.BufferUpdated
    then
        // 1. Actualizar Buffer y Offline status
        // Nota: El reset de flags se recomienda hacer en Go antes de Execute()
        IncomingPacket.BufferHas10 = state.UpdateMemoryBuffer(IncomingPacket.Speed, IncomingPacket.GSMSignalStrength, IncomingPacket.Datetime, IncomingPacket.PositioningStatus, IncomingPacket.Latitude, IncomingPacket.Longitude);
        IncomingPacket.IsOfflineFor5Min = state.IsOfflineFor(5);
        
        // 2. Marcar como actualizado para activar las siguientes reglas
        IncomingPacket.BufferUpdated = true;
        actions.Log("[DEFCON 0] Surveillance Active. Buffer Updated.");
        actions.CaptureSnapshot("DEFCON0_Surveillance");
}

// --- DEFCON 1 ---

rule DEFCON1_ContactLost_Pass "DEFCON 1: Contact Lost (V)" salience 900 {
    when
        IncomingPacket.BufferUpdated && IncomingPacket.PositioningStatus == "V" && !IncomingPacket.PositionInvalidDetected
    then
        IncomingPacket.PositionInvalidDetected = true;
        actions.Log("[DEFCON 1] Positive: Status V detected.");
        actions.CaptureSnapshot("DEFCON1_ContactLost_Pass");
}

// --- DEFCON 2 ---

rule DEFCON2_CalculateMetrics "DEFCON 2: Calculate Average Metrics" salience 850 {
    when
        IncomingPacket.PositionInvalidDetected && IncomingPacket.BufferHas10 && !IncomingPacket.MetricsReady
    then
        // Extraer mÃ©tricas del buffer de 90 min y Ãºltimas 5 posiciones
        state.JammerAvgSpeed90min = state.GetAverageSpeed90Min(IncomingPacket.IMEI);
        state.JammerAvgGsm5 = state.GetAverageGSMLast5(IncomingPacket.IMEI);
        
        IncomingPacket.MetricsReady = true;
        actions.Log("[DEFCON 2] Metrics Ready: AvgSpeed=" + actions.CastString(state.JammerAvgSpeed90min) + " AvgGSM=" + actions.CastString(state.JammerAvgGsm5));
        actions.CaptureSnapshot("DEFCON2_CalculateMetrics");
}

rule DEFCON2_Inhibition_Pass "DEFCON 2: Inhibition Confirmed" salience 800 {
    when
        IncomingPacket.MetricsReady && !IncomingPacket.MovingWithWeakSignal &&
        state.JammerAvgSpeed90min >= 10 && 
        state.JammerAvgGsm5 < 15
    then
        IncomingPacket.MovingWithWeakSignal = true;
        actions.Log("[DEFCON 2] Positive: Inhibition Pattern Match (Moving & Low GSM).");
        actions.CaptureSnapshot("DEFCON2_Inhibition_Pass");
}

// --- DEFCON 3 ---

rule DEFCON3_SafeZones_Pass "DEFCON 3: Outside Safe Zones" salience 700 {
    when
        IncomingPacket.MovingWithWeakSignal && !IncomingPacket.OutsideAllSafeZones &&
        IncomingPacket.IsOfflineFor5Min &&
        !state.IsInsideGroup("Taller", IncomingPacket.Latitude, IncomingPacket.Longitude) && 
        !state.IsInsideGroup("CLIENTES", IncomingPacket.Latitude, IncomingPacket.Longitude)
    then
        IncomingPacket.OutsideAllSafeZones = true;
        actions.Log("[DEFCON 3] Outside Safe Zones & Offline.");
        actions.CaptureSnapshot("DEFCON3_SafeZones_Pass");
}

// --- DEFCON 4 ---

rule DEFCON4_JammerAlert_Fire "DEFCON 4: JAMMER ALERT" salience 600 {
    when
        IncomingPacket.OutsideAllSafeZones && 
        !state.IsAlertSentForRule("DEFCON4_JammerAlert_Fire")
    then
        state.MarkAlertSentForRule("DEFCON4_JammerAlert_Fire");
        actions.Log("[DEFCON 4] !!! JAMMER DETECTED !!!");
        actions.SendTelegram(
            "ðŸš¨ JAMMER REAL DETECTADO - IMEI: " + IncomingPacket.IMEI + "\n" + 
            "ðŸ“‹ DEFCON 4 ALCANZADO\n" + 
            "ðŸš— Vel Prom (90min): " + actions.CastString(state.JammerAvgSpeed90min) + " km/h\n" + 
            "ðŸ“¡ GSM Prom (Ãºlt 5): " + actions.CastString(state.JammerAvgGsm5) + "\n" + 
            "ðŸ“ Lat: " + actions.CastString(IncomingPacket.Latitude) + " | Lon: " + actions.CastString(IncomingPacket.Longitude) + "\n" + 
            "ðŸ• Hora: " + actions.CastString(IncomingPacket.Datetime)
        );
        actions.CaptureSnapshot("DEFCON4_JammerAlert_Fire");
}