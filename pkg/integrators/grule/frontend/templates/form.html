{% extends "base.html" %}

{% block title %}{{ title }} - Grule Engine{% endblock %}

{% block content %}

<!-- Header -->
<div class="header">
    <h1>
        {% if rule %}
            <i class="fas fa-edit"></i> Editar Regla
        {% else %}
            <i class="fas fa-plus-circle"></i> Nueva Regla
        {% endif %}
    </h1>
    <a href="/" class="back-link">
        <i class="fas fa-arrow-left"></i> Volver al listado
    </a>
</div>

<!-- Main Content -->
<div class="main-content">
    <!-- Left: Form -->
    <div class="form-card">
        <form method="post" id="ruleForm">
            <!-- Nombre -->
            <div class="form-group mb-4">
                <label for="name" class="form-label">
                    <i class="fas fa-tag"></i> Nombre de la Regla *
                </label>
                <input type="text" class="form-control" id="name" name="name" required 
                       value="{{ rule.name if rule else '' }}" 
                       placeholder="Ej: ExcesoVelocidad120">
                <div class="help-text">
                    <i class="fas fa-info-circle"></i> Identifica √∫nica de la regla en el sistema
                </div>
            </div>

            <!-- Prioridad -->
            <div class="form-group mb-4">
                <label for="priority" class="form-label">
                    <i class="fas fa-layer-group"></i> Prioridad (Priority)
                </label>
                <input type="number" class="form-control" id="priority" name="priority" 
                       value="{{ rule.priority if rule else 10 }}" 
                       min="1" max="1000">
                <div class="help-text">
                    <i class="fas fa-info-circle"></i> Valores altos = mayor prioridad de ejecuci√≥n
                </div>
            </div>

            <!-- Estado -->
            <div class="form-group mb-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="active" name="active" {% if rule and rule.active %}checked{% endif %}>
                    <label class="form-check-label" for="active">
                        <i class="fas fa-power-off"></i> Regla activa
                    </label>
                </div>
                <div class="help-text">
                    Desactiva para pausar sin eliminar la regla
                </div>
            </div>

            <!-- C√≥digo GRL y Audit Manifest Tabs -->
            <div class="mb-4">
                <ul class="nav nav-tabs mb-2" id="ruleTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="grl-tab" data-bs-toggle="tab" data-bs-target="#grl-pane" type="button" role="tab">
                            <i class="fas fa-code"></i> C√≥digo GRL *
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="manifest-tab" data-bs-toggle="tab" data-bs-target="#manifest-pane" type="button" role="tab">
                            <i class="fas fa-file-code"></i> Audit Manifest (YAML)
                            <span id="yaml-badge" class="badge bg-secondary ms-1 {% if not rule or not rule.audit_manifest %}d-none{% endif %}">YAML</span>
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="ruleTabsContent">
                    <div class="tab-pane fade show active" id="grl-pane" role="tabpanel" aria-labelledby="grl-tab">
                        <textarea class="form-control code-editor" id="grl" name="grl" required rows="15">{{ rule.grl if rule else '' }}</textarea>
                        <div class="help-text mt-1">
                            <i class="fas fa-info-circle"></i> Grule Rule Language - sintaxis requiere validaci√≥n
                        </div>
                    </div>
                    <div class="tab-pane fade" id="manifest-pane" role="tabpanel" aria-labelledby="manifest-tab">
                        <textarea class="form-control code-editor" id="audit_manifest" name="audit_manifest" rows="15" 
                                  placeholder="# No audit manifest for this rule">{{ rule.audit_manifest if rule else '' }}</textarea>
                        <div class="help-text mt-1">
                            <i class="fas fa-info-circle"></i> Opcional: Define etapas, orden y niveles de auditor√≠a
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Right: Templates Sidebar -->
    <div class="sidebar">
        <div class="form-card">
            <h5>
                <i class="fas fa-book"></i> Plantillas R√°pidas
            </h5>
            <div class="templates-wrapper" id="templatesContainer">
                <!-- Se llena din√°micamente con JS -->
            </div>
        </div>
    </div>
</div>

<!-- Actions -->
<div class="form-actions">
    <button type="button" onclick="validateSyntax()" class="btn btn-secondary">
        <i class="fas fa-check-circle"></i> Validar Sintaxis
    </button>
    <button type="submit" form="ruleForm" class="btn btn-primary">
        <i class="fas fa-save"></i> Guardar Regla
    </button>
    <a href="/" class="btn btn-light">
        <i class="fas fa-times-circle"></i> Cancelar
    </a>
    {% if rule %}
    <form action="{{ url_for('delete_rule', rule_id=rule.id) }}" method="post" onsubmit="return confirm('¬øEst√°s seguro de que quieres eliminar esta regla?');" style="display:inline;">
        <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash-alt"></i> Eliminar Regla
        </button>
    </form>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
    // Datos de plantillas (desde el backend)
    const templates = {{ templates_json | tojson }};

    // Agrupar por categor√≠a
    const templatesByCategory = {};
    for (const [key, template] of Object.entries(templates)) {
        const category = template.category || 'Otros';
        if (!templatesByCategory[category]) {
            templatesByCategory[category] = [];
        }
        templatesByCategory[category].push({key, ...template});
    }

    // Renderizar plantillas
    function renderTemplates() {
        const container = document.getElementById('templatesContainer');
        container.innerHTML = '';

        for (const [category, items] of Object.entries(templatesByCategory)) {
            // Categor√≠a
            const categoryDiv = document.createElement('div');
            categoryDiv.style.marginBottom = '0';

            const categoryTitle = document.createElement('div');
            categoryTitle.className = 'category-title';
            categoryTitle.textContent = category;
            categoryDiv.appendChild(categoryTitle);

            // Plantillas de la categor√≠a
            for (const template of items) {
                const card = document.createElement('div');
                card.className = 'template-card';
                
                const header = document.createElement('div');
                header.className = 'template-header';
                header.innerHTML = '<i class="fas fa-caret-right"></i> ' + template.name;
                card.appendChild(header);
                
                const body = document.createElement('div');
                body.className = 'template-body';
                
                const desc = document.createElement('div');
                desc.className = 'template-desc';
                desc.textContent = template.description;
                body.appendChild(desc);
                
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'template-btn';
                btn.innerHTML = '<i class="fas fa-paste"></i> Usar plantilla';
                btn.onclick = function() {
                    applyTemplate(template.name, template.grl, template.audit_manifest);
                };
                body.appendChild(btn);
                
                card.appendChild(body);
                categoryDiv.appendChild(card);
            }

            container.appendChild(categoryDiv);
        }
    }

    // Aplicar plantilla
    function applyTemplate(name, grl, audit_manifest) {
        document.getElementById('name').value = name;
        document.getElementById('grl').value = grl;
        document.getElementById('audit_manifest').value = audit_manifest || '';
        
        // Actualizar badge
        updateYamlBadge();
        
        // Si hay manifiesto, mostrar un peque√±o aviso o cambiar de tab brevemente?
        // Por ahora solo actualizar el badge es suficiente.

        // Scroll al editor
        document.querySelector('.form-card').scrollIntoView({behavior: 'smooth'});
    }

    function updateYamlBadge() {
        const yaml = document.getElementById('audit_manifest').value;
        const badge = document.getElementById('yaml-badge');
        if (yaml && yaml.trim()) {
            badge.classList.remove('d-none');
            const lines = yaml.trim().split('\n').length;
            badge.textContent = lines + (lines === 1 ? ' line' : ' lines');
        } else {
            badge.classList.add('d-none');
        }
    }

    // Listener para actualizar badge manualmente
    document.getElementById('audit_manifest').addEventListener('input', updateYamlBadge);

    // Initial check
    updateYamlBadge();

    // Form submission handler to debug data
    document.getElementById('ruleForm').addEventListener('submit', function(e) {
        const grl = document.getElementById('grl').value;
        const manifest = document.getElementById('audit_manifest').value;
        console.log('üì§ Submitting form:');
        console.log('  GRL length:', grl.length);
        console.log('  Manifest length:', manifest.length);
        console.log('  Manifest content:', manifest.substring(0, 100));
        // Don't prevent default, let it submit normally
    });

    // Validar sintaxis
    async function validateSyntax() {
        const grl = document.getElementById('grl').value;
        if (!grl.trim()) {
            alert('‚ö†Ô∏è El c√≥digo GRL no puede estar vac√≠o');
            return;
        }

        try {
            const response = await fetch('/api/validate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({grl})
            });
            
            const data = await response.json();
            
            if (data.valid) {
                alert('‚úÖ ¬°Sintaxis v√°lida!');
            } else {
                alert(`‚ùå Error de sintaxis:\n\n${data.error}`);
            }
        } catch (error) {
            alert(`‚ùå Error: ${error.message}`);
        }
    }

    // Inicializar plantillas
    renderTemplates();
</script>
{% endblock %}